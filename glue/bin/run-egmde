#!/bin/bash
set -e

if [ $(id -u) ]; then
  if [ ! -e $SNAP_COMMON/login-session-control.connected ]; then
    echo To run as non-root user:
    echo sudo snap connect egmde-confined-desktop:login-session-control :login-session-control
  fi
  echo To add to login shells:
  echo sudo cp /snap/egmde-confined-desktop/current/usr/share/wayland-sessions/egmde-confined-desktop.desktop /usr/share/wayland-sessions/
  if [ ! -e $SNAP_COMMON/login-session-control.connected ]; then
    exit 1
  fi
  echo To run as daemon:
  echo sudo snap set egmde-confined-desktop daemon=enable
else
  if [ -d /run/user/0 ] || mkdir -p /run/user/0 -m 700; then
    # Until https://bugs.launchpad.net/snapd/+bug/1804869/ is resolved,
    # this works on Ubuntu Core (and in devmode on Ubuntu Classic)
    # but not confined on Ubuntu Classic
    export XDG_RUNTIME_DIR=/run/user/0
  fi
fi

mkdir -p $XDG_RUNTIME_DIR -m 700
mkdir -p $XDG_CACHE_HOME

# Make PulseAudio socket available inside the snap-specific $XDG_RUNTIME_DIR
pulsenative="pulse/native"
pulseaudio_sockpath="$XDG_RUNTIME_DIR/$pulsenative"
if [ -S "$pulseaudio_sockpath" ]; then
    export PULSE_SERVER="unix:${pulseaudio_sockpath}"
fi

cd $HOME
exec desktop-launch $SNAP/bin/egmde $@

