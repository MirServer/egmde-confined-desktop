#!/bin/bash

set -e

display_changes=0
config_changes=0
egmde_display="$SNAP_USER_DATA/.config/egmde.display"
egmde_config="$SNAP_USER_DATA/.config/egmde.config"

[ ! -d "$SNAP_USER_DATA/.config" ] && mkdir $SNAP_USER_DATA/.config -m 700

# Ensure we have a config file with the fixed options
if [ ! -e "${egmde_config}" ]; then
cat <<EOT > "${egmde_config}"
arw-file=
file=/run/mir_socket
console-provider=vt
EOT
let config_changes+=1
fi

# Hack to workaround issue #704
if [[ $(uname -r) =~ ^.*raspi2$ ]]; then
  env_hacks=$(sed -n 's/^env-hacks=\(.*\)$/\1/p' ${egmde_config})
  if [[ ! ${env_hacks} =~ .*MIR_MESA_KMS_DISABLE_MODESET_PROBE* ]]
  then
    sed --in-place '/^env-hacks=/d' ${egmde_config}
    env_hacks=env-hacks=${env_hacks}:MIR_MESA_KMS_DISABLE_MODESET_PROBE
    echo ${env_hacks/=:/=} >> "${egmde_config}"
  fi
fi

# display-config
if display_config=$(snapctl get display-config); then
  if [ -n "${display_config}" ]; then
    echo "# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN" > "${egmde_display}~"
    echo "# USE 'snap set egmde-confined-desktop display-config=...' INSTEAD" >> "${egmde_display}~"
    echo ""                                                                   >> "${egmde_display}~"
    echo "${display_config}"                                                  >> "${egmde_display}~"
    if [ -e "${egmde_display}" ]; then
      if ! diff "${egmde_display}~" "${egmde_display}" > /dev/null; then
        mv "${egmde_display}"  "${egmde_display}.save"
        mv "${egmde_display}~" "${egmde_display}"
        let display_changes+=1
      else
        rm "${egmde_display}~"
      fi
    else
      mv "${egmde_display}~" "${egmde_display}"
      let display_changes+=1
    fi
  else
    if [ -e "${egmde_display}" ]; then
      if grep "# USE 'snap set egmde-confined-desktop display-config=...' INSTEAD" "${egmde_display}"; then
        mv "${egmde_display}"  "${egmde_display}.save"
        let display_changes+=1
      fi
    fi
  fi
fi

# display-layout
display_layout=$(snapctl get display-layout)
if [ -n "${display_layout}" ]; then
  if [ -e "${egmde_display}" ]; then
    if [ -z "$(grep "^  ${display_layout}:" "${egmde_display}")" ]; then
      echo "ERROR: '$display_layout' is not a layout in ${egmde_display}"
      exit 1
    fi
  else
    if [ "${display_layout}" != "default" ]; then
      echo "ERROR: '$display_layout' is not a layout in ${egmde_display}"
      exit 1
    fi
  fi

  if [ "display-layout=${display_layout}" != "$(grep \^display-layout= ${egmde_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^display-layout=/d' ${egmde_config}
    else
      sed --in-place=.save '/^display-layout=/d' ${egmde_config}
    fi
    echo display-layout=${display_layout} >> ${egmde_config}
    let config_changes+=1
  fi
fi

# vt
vt=$(snapctl get vt)
if [ -n "${vt}" ]; then
  if [ -n "${vt//[0-9]}" ] || [ ! -e "/dev/tty$vt" ]; then
    echo "ERROR: '$vt' is not a valid VT"
    exit 1
  fi

  if [ "vt=${vt}" != "$(grep vt= ${egmde_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^vt/d' ${egmde_config}
    else
      sed --in-place=.save '/^vt/d' ${egmde_config}
    fi
    echo vt=${vt} >> ${egmde_config}
    let config_changes+=1
  fi
fi

# cursor
cursor=$(snapctl get cursor)
if [ -n "${cursor}" ]; then
  if [[ ! "${cursor}" =~ ^(auto|none|software)$ ]]; then
    echo "ERROR: '$cursor' is not a valid cursor option (auto|none|software)"
    exit 1
  fi

  if [ "${cursor}" == "none" ]; then
    cursor="null"
  fi

  if [ "cursor=${cursor}" != "$(grep cursor= $SNAP_USER_DATA/egmde.config)" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^cursor/d' ${egmde_config}
    else
      sed --in-place=.save '/^cursor/d' ${egmde_config}
    fi
    echo cursor=${cursor} >> ${egmde_config}
    let config_changes+=1
  fi
fi

#if [ $(($config_changes+$display_changes)) -gt 0 ]; then
#  snapctl restart $SNAP_NAME
#fi
if daemon=$(snapctl get daemon); then
  if [ -n "${daemon}" ]; then
    snapctl restart $SNAP_NAME
  fi
fi
